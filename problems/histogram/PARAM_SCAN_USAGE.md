# CUDA 内部参数扫描使用说明

## 实现方式

参数扫描已直接在 CUDA 代码 (`template.cu`) 中实现，无需外部脚本。

## 工作原理

1. **第一次调用时**：自动测试 8 个关键配置组合
2. **选择最佳配置**：根据执行时间选择最快的配置
3. **缓存配置**：使用静态变量缓存最佳配置，后续调用直接使用

## 配置说明

代码会测试以下 8 个配置：

```cpp
1. {256, 64, 33, 75, 256}  // Baseline
2. {256, 64, 33, 50, 256}  // shared_mem_carveout = 50
3. {256, 64, 33, 100, 256} // shared_mem_carveout = 100
4. {256, 32, 64, 75, 256}  // channels_per_block = 32
5. {256, 48, 32, 75, 256}  // channels_per_block = 48
6. {256, 64, 16, 75, 256}  // target_chunks = 16
7. {256, 64, 64, 75, 256}  // target_chunks = 64
8. {256, 32, 64, 50, 256}  // Best combination
```

参数顺序：`{block_size, channels_per_block, target_chunks, shared_mem_carveout, reduce_block_size}`

## 使用方法

### 方法 1: 启用参数扫描（推荐用于测试）

代码默认启用参数扫描。直接使用即可：

```bash
# 1. 确保 template.cu 中有 #define ENABLE_PARAM_SCAN（默认已启用）
# 2. 生成 submission.cu
cp template.cu submission.cu

# 3. 提交到服务器
# 第一次运行会自动测试所有配置并选择最佳的
```

**注意**：第一次调用会较慢（需要测试 8 个配置），后续调用会使用缓存的配置，速度正常。

### 方法 2: 禁用参数扫描（用于最终提交）

如果已经找到最佳配置，可以禁用参数扫描以提高速度：

```cpp
// 在 template.cu 文件开头，注释掉或删除这一行：
// #define ENABLE_PARAM_SCAN

// 或者改为：
#undef ENABLE_PARAM_SCAN
```

禁用后，代码会使用固定的配置：`{256, 64, 33, 75, 256}`

### 方法 3: 手动设置最佳配置

如果通过参数扫描找到了最佳配置，可以：

1. **禁用参数扫描**（注释掉 `#define ENABLE_PARAM_SCAN`）
2. **修改固定配置**：

```cpp
#else
    // 使用你找到的最佳配置
    KernelConfig config = {256, 32, 64, 50, 256};  // 替换为你的最佳配置
    return run_histogram_with_config(data, num_bins, config);
#endif
```

## 修改测试配置

如果想测试其他参数组合，修改 `template.cu` 中的配置数组：

```cpp
const int num_configs = 8;
KernelConfig configs[num_configs] = {
    {256, 64, 33, 75, 256},  // 你的配置 1
    {256, 64, 33, 50, 256},  // 你的配置 2
    // ... 添加更多配置
};
```

## 性能考虑

- **启用参数扫描**：第一次调用慢（~8x 正常时间），后续调用正常
- **禁用参数扫描**：所有调用都使用固定配置，最快

**建议**：
1. 开发/测试阶段：启用参数扫描，自动找到最佳配置
2. 最终提交：禁用参数扫描，使用找到的最佳配置

## 工作流程

```
1. 修改 template.cu（可选：调整测试配置）
   ↓
2. 生成 submission.cu
   cp template.cu submission.cu
   ↓
3. 提交到 H100 服务器
   ↓
4. 第一次运行：自动测试所有配置，选择最佳
   ↓
5. 后续运行：使用缓存的最佳配置（快速）
```

## 注意事项

1. **静态变量**：最佳配置缓存在静态变量中，在同一进程内有效
2. **多进程**：如果服务器使用多进程，每个进程会独立测试一次
3. **测试时间**：每个配置测试 5 次取平均，第一次调用可能需要几秒
4. **正确性**：参数扫描只测试性能，不验证正确性（假设所有配置都正确）

## 示例：找到最佳配置后的优化

假设通过参数扫描发现配置 `{256, 32, 64, 50, 256}` 最快：

1. 修改 `template.cu`：
   ```cpp
   // 注释掉参数扫描
   // #define ENABLE_PARAM_SCAN
   
   // 使用最佳配置
   KernelConfig config = {256, 32, 64, 50, 256};
   ```

2. 重新生成 `submission.cu` 并提交

这样所有调用都会直接使用最佳配置，无需每次测试。

